<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    <title>AS3 Link Report Diff Tool</title>
    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
    <link href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css" rel="stylesheet">
    <style type="text/css">
    tbody.hidden{
      display: none;
    }
    </style>
  </head>
  <body>
    
  <div class="container">
    <h1>AS3 Link Report Diff Tool</h1>
    
    <div class="row">
      <div class="span12">
        <form class="form-inline" role="form" style="text-align:center">
          <span class="glyphicon glyphicon-cloud-upload"></span>
          <input class="form-control" id="newFileInput" type="text" placeholder="New Link Report">
          <span class="glyphicon glyphicon-chevron-left"></span>
          <button type="button" id="diffButton" class="btn btn-success">Diff Files</button>
          <span class="glyphicon glyphicon-chevron-right"></span>
          <input class="form-control" id="oldFileInput" type="text" placeholder="Old Link Report">
          <span class="glyphicon glyphicon-cloud-upload"></span>
        </form>
      </div>
    </div>

    <div class="row">
      <div class="span12">
      <table class="table table-bordered table-hover table-striped" id="tableData">
      <thead>
        <tr>
          <th>Class</th>
          <th>New Size</th>
          <th>Old Size</th>
          <th>Change</th>
        </tr>
      </thead>
      </table>
      </div>
    </div>


    </div>
    <script type="text/javascript" src="../linkReportDiff.js"></script>
    <script>
      (function(){
        
        function handleDragOverEvent(e) {
          if (e.preventDefault) {
            e.preventDefault(); // Necessary. Allows us to drop.
          }
          e.dataTransfer.dropEffect = 'move';
          return false;
        }
        
        function loadFile(f, cb){
          var reader = new FileReader();

          reader.onload = function(e){
            cb(reader.result);
          }
          
          reader.readAsText(f);
        }
        
        function handleDropEvent(e) {
          // this / e.target is current target element.
          if (e.preventDefault) {
            e.preventDefault(); // Necessary. Allows us to drop.
          }

          if (e.stopPropagation) {
            e.stopPropagation(); // stops the browser from redirecting.
          }
        
          return e.dataTransfer.files[0];
        }    

        function attachFileLoader(el, cb){
          el.addEventListener('dragover', handleDragOverEvent, false);
          el.addEventListener('drop', function(e){
            var f = handleDropEvent(e);
            loadFile(f, cb);
            var text = f.name + " (" + Math.round(f.size / 1024) + "kb)";
            el.value = text;
            return false;
          }, false);
        }

        function displayResult(result){
          addTotalsHeader(result);
          addReportTable("Added Classes", result.added);
          addReportTable("Removed Classes", result.removed);
          addReportTable("Bigger Classes", result.bigger);
          addReportTable("Smaller Classes", result.smaller);
          addReportTable("Same Classes", result.same);
        }

        function addReportTable(title, report){
          var tableEl = document.querySelector("#tableData");
          var header = createTableHeaderElement(title, report.newSize, report.oldSize, report.diff, true);
          var body = createTableBodyElement(report.items);

          tableEl.appendChild(header);
          tableEl.appendChild(body);
        }

        function addTotalsHeader(report){
          var tableEl = document.querySelector("#tableData");
          var header = createTableHeaderElement("Totals", report.totalNewSize, report.totalOldSize, report.totalDiff, false);
          tableEl.appendChild(header);
        }

        function createTableHeaderElement(title, newSize, oldSize, diff, hideLink){
          var thead = document.createElement("thead");
          var tr = document.createElement("tr");
          
          var t = document.createElement("th");
          t.innerHTML = title;

          if(hideLink){
            createHideLink(t);
          }

          var n = document.createElement("th");
          n.innerHTML = newSize;

          var o = document.createElement("th");
          o.innerHTML = oldSize;

          var d = document.createElement("th");
          d.innerHTML = diff;

          tr.appendChild(t);
          tr.appendChild(n);
          tr.appendChild(o);
          tr.appendChild(d);
          thead.appendChild(tr);
          return thead;
        }

        function createHideLink(tEl){
          var a = document.createElement("a");
          a.innerHTML = " (hide)";

          a.addEventListener("click", function(e){
            var tHead = a.parentNode.parentNode.parentNode;
            var tBody = tHead.nextSibling;
            
            if(tBody.className == "hidden"){
              tBody.className = "";
              a.innerHTML = " (hide)"
            }else{
              tBody.className = "hidden"
              a.innerHTML = " (show)"
            }

          }, false);

          tEl.appendChild(a);
        }

        function createTableBodyElement(items){
          var tbody = document.createElement("tbody");

          var item = null;
          for(var i = 0, l = items.length; i<l; i++){
            item = items[i];
            var tr = document.createElement("tr");

            var name = createTD(), o = createTD(), n = createTD(), diff = createTD();

            name.innerHTML = item.name;
            o.innerHTML = item.newSize;
            n.innerHTML = item.oldSize;
            diff.innerHTML = item.diff;

            tr.appendChild(name);
            tr.appendChild(o);
            tr.appendChild(n);
            tr.appendChild(diff);

            tbody.appendChild(tr);
          }

          return tbody;
        }

        function createTD(){
            return document.createElement("td");
        }

        function setupDOMHandlers(newFileDropEl, oldFileDropEl, diffTriggerEl){
          var diffConfig = {
            newData:"",
            oldData:""
          };
          attachFileLoader(newFileDropEl, function(data){
            diffConfig.newData = data;
          });
          attachFileLoader(oldFileDropEl, function(data){
            diffConfig.oldData = data;
          });
          diffTriggerEl.addEventListener("click", function(e){
            displayResult(LinkReportDiff.diffTextSources(diffConfig.newData, diffConfig.oldData));
          }, false);
        }

        var newFileEl = document.querySelector("#newFileInput");
        var oldFileEl = document.querySelector("#oldFileInput");
        var diffBtn = document.querySelector("#diffButton");

        setupDOMHandlers(newFileEl, oldFileEl, diffBtn);
        
      }());
    </script>
  </body>
</html>